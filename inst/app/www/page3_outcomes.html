<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="w3style.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shiny/1.6.0/shiny.min.js"></script> <!-- Add Shiny's JS library -->
</head>
<body class="secondary">
<!-- Outcomes page -->
<div class="page3">
  <!-- Header -->
  <div class="header">
      <button class="close_button" id="back_to_home">&#x00D7;</button>
      <h1><span class="repurpose-symbol">&#x267A;</span></h1>
  </div>

  <!-- Get Started -->
  <div class="column">
    <h3>What is the outcome of interest?</h3>
    <select name="outcome" id="firstSelect" onchange="updateSecondSelect(); updateCheckboxes();">
      <option value="subjid">Subjid</option>
      <option value="sex">Sex</option>
      <option value="obese">Obese</option>
      <option value="nafld">NAFLD</option>
      <option value="age">Age</option>
      <option value="bmizscore">BMIzscore</option>
    </select>

    <h3>Was this study designed for some other outcome?</h3>
    <input type="radio" id="no" name="fav_language" value="False" checked="checked">
    <label for="no">No</label><br>
    <input type="radio" id="yes" name="fav_language" value="True">
    <label for="yes">Yes</label><br>

    <!-- This question should only appear when "Yes" is selected -->
    <div class="actual_outcome_of_study" id="outcome_study" name="question" style="display: none;">
      <h3>What was the study designed for?</h3>
      <select name="outcome" id="secondSelect" onchange="updateCheckboxes();">
        <option value="subjid">Subjid</option>
        <option value="sex">Sex</option>
        <option value="obese">Obese</option>
        <option value="nafld">NAFLD</option>
        <option value="age">Age</option>
        <option value="bmizscore">BMIzscore</option>
      </select>
    </div>
    <br>
  </div>

  <!-- Checkboxes should always appear -->
  <div class="column" id="checkbox_question">
    <!-- Ensure the heading is preserved -->
  </div>

  <div class="footer_outcome">
    <button class="button" id="back2">Back</button>
    <button class="button" id="next4">Next</button>
  </div>
</div>

<script>
  let checkboxesCreated = false;
  const options = ["subjid", "sex", "obese", "nafld", "age", "bmizscore"];  // Updated options

  // Function to hide the second outcome select if the "No" radio button is selected
  function hideOutcomeQuestion() {
    document.getElementById("outcome_study").style.display = "none";
  }

  // Function to show the second outcome select if the "Yes" radio button is selected
  function showOutcomeQuestion() {
    document.getElementById("outcome_study").style.display = "block";
  }

  // Set up event listeners for the radio buttons to communicate with Shiny
  document.getElementById('no').addEventListener('click', function() {
    Shiny.setInputValue('fav_language', 'False');
    hideOutcomeQuestion();
  });

  document.getElementById('yes').addEventListener('click', function() {
    Shiny.setInputValue('fav_language', 'True');
    showOutcomeQuestion();
  });

  // Set up event listener for first select dropdown
  document.getElementById('firstSelect').addEventListener('change', function() {
    Shiny.setInputValue('firstSelect', this.value);
    updateSecondSelect();
    updateCheckboxes();
  });

  // Function to dynamically update the second select dropdown
  function updateSecondSelect() {
    const firstSelect = document.getElementById("firstSelect");
    const secondSelect = document.getElementById("secondSelect");

    // Clear second select options
    secondSelect.innerHTML = '';

    options.forEach(option => {
      if (firstSelect.value !== option) {
        const opt = document.createElement("option");
        opt.value = option;
        opt.text = option.charAt(0).toUpperCase() + option.slice(1); 
        secondSelect.add(opt);
      }
    });

    Shiny.setInputValue('secondSelect', secondSelect.value);
  }

  // Function to dynamically create checkboxes and send the values to Shiny
  function updateCheckboxes() {
    const firstSelect = document.getElementById("firstSelect");
    const secondSelect = document.getElementById("secondSelect");
    const container = document.getElementById("checkbox_question");

    // Clear previous checkboxes
    container.innerHTML = '';

    // Add the heading inside the checkbox container
    const heading = document.createElement("h3");
    heading.innerHTML = "What factors in metadata should be adjusted for?";
    container.appendChild(heading);

    // Create checkboxes based on the selected options
    options.forEach(option => {
      if (firstSelect.value !== option && (!secondSelect || secondSelect.value !== option)) {
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = option;
        checkbox.name = "adjust_factors"; // Same name for group capture
        checkbox.value = option;

        // Add event listener to each checkbox to communicate with Shiny
        checkbox.addEventListener('change', function() {
          let selectedCheckboxes = Array.from(document.querySelectorAll('input[name="adjust_factors"]:checked')).map(cb => cb.value);
          Shiny.setInputValue('adjust_factors', selectedCheckboxes);
        });

        const label = document.createElement("label");
        label.htmlFor = option;
        label.appendChild(document.createTextNode(option.charAt(0).toUpperCase() + option.slice(1)));

        container.appendChild(checkbox);
        container.appendChild(label);
        container.appendChild(document.createElement("br"));
      }
    });
  }

  // Initialize the page with default settings
  window.onload = function() {
    updateSecondSelect();
    updateCheckboxes();

    var selectedValue = document.querySelector('input[name="fav_language"]:checked').value;
    if (selectedValue === "True") {
      showOutcomeQuestion();
    } else {
      hideOutcomeQuestion();
    }
  };

</script>

</body>
</html>
